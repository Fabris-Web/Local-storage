<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FABRIS Safe Voting - Session Manager Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fbff;
            --bg-tertiary: #fff9e6;
            --text-primary: #123;
            --text-secondary: #234;
            --text-tertiary: #556;
            --text-quaternary: #456;
            --border-color: #e0e0e0;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 15px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.15);
            --accent-primary: #ffc107;
            --accent-light: #ffcd38;
            --accent-dark: #ffa000;
        }

        html[data-theme="dark"] {
            --bg-primary: #0a0a12;
            --bg-secondary: #121220;
            --bg-tertiary: #1a1a2a;
            --text-primary: #f0f0f0;
            --text-secondary: #e0e0e0;
            --text-tertiary: #b0b0b0;
            --text-quaternary: #888;
            --border-color: #1f2a3f;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.6);
            --shadow-md: 0 4px 15px rgba(0, 0, 0, 0.7);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.8);
            --accent-primary: #ffc107;
            --accent-light: #ffd740;
            --accent-dark: #ff9800;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, #f0fff4 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: background 0.3s ease;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 24px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            flex-wrap: wrap;
            gap: 20px;
            transition: all 0.3s ease;
        }

        .header h1 {
            font-size: clamp(1.5rem, 4vw, 2rem);
            color: var(--text-primary);
            margin: 0;
        }

        .header p {
            color: var(--text-tertiary);
            margin: 0;
            font-size: 0.95rem;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .dark-mode-toggle {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-light));
            color: #333;
            border: none;
            padding: 8px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dark-mode-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.3);
        }

        .dark-mode-toggle:active {
            transform: translateY(0);
        }

        .section {
            margin-bottom: 30px;
            padding: 24px;
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .section h2 {
            color: var(--text-primary);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: clamp(1.2rem, 3vw, 1.6rem);
            border-bottom: 3px solid var(--border-color);
            padding-bottom: 12px;
        }

        .section h3 {
            color: var(--text-secondary);
            margin-top: 16px;
            margin-bottom: 12px;
            font-size: clamp(1rem, 2.5vw, 1.3rem);
        }

        .section h4 {
            color: var(--text-quaternary);
            margin-top: 12px;
            margin-bottom: 10px;
            font-size: clamp(0.95rem, 2vw, 1.1rem);
        }

        .users-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: clamp(0.8rem, 2vw, 1rem);
        }

        .users-list th,
        .users-list td {
            padding: clamp(8px, 2vw, 12px);
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .users-list th {
            background: linear-gradient(135deg, #ffc107, #ffb300);
            color: #333;
            font-weight: 600;
        }

        .users-list tr:hover {
            background: #c5b41fc0;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }

        .status-pending {
            background: #ff9800;
            color: white;
        }

        .status-approved {
            background: #28a745;
            color: white;
        }

        .status-rejected {
            background: #dc3545;
            color: white;
        }

        .btn {
            background: linear-gradient(135deg, #ffc107, #ffb300);
            color: #333;
            padding: clamp(10px, 2vw, 12px) clamp(16px, 3vw, 18px);
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: clamp(0.85rem, 2vw, 1rem);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.3);
            background: linear-gradient(135deg, #ffb300, #ff9f00);
        }

        .btn-approve {
            background: linear-gradient(135deg, #28a745, #20b36b);
            color: white;
            padding: clamp(8px, 1.5vw, 10px) clamp(12px, 2vw, 16px);
            font-size: clamp(11px, 2vw, 12px);
            border-radius: 6px;
        }

        .btn-approve:hover {
            background: linear-gradient(135deg, #228836, #1a9555);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.25);
        }

        .btn-reject {
            background: linear-gradient(135deg, #dc3545, #e74c5c);
            color: white;
            padding: clamp(8px, 1.5vw, 10px) clamp(12px, 2vw, 16px);
            font-size: clamp(11px, 2vw, 12px);
            border-radius: 6px;
        }

        .btn-reject:hover {
            background: linear-gradient(135deg, #c82333, #dc3545);
            box-shadow: 0 6px 16px rgba(220, 53, 69, 0.25);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #fffbf0, #ffffff);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #ffe0b2;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.2);
            border-color: #ffc107;
        }

        .stat-number {
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            font-weight: bold;
            color: #ffc107;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #556;
            margin-top: 5px;
            font-size: clamp(0.85rem, 2vw, 0.95rem);
            font-weight: 500;
        }

        .session-badge {
            background: linear-gradient(135deg, #ffc107, #ffb300);
            color: #333;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            font-size: clamp(0.8rem, 2vw, 0.95rem);
        }

        .filter-search {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-search input {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .filter-search input:focus {
            outline: none;
            border-color: #ffc107;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.2);
        }

        /* Form styling */
        #sessionFormSection {
            display: none;
            margin-bottom: 16px;
            padding: 16px;
            border: 2px solid #ffe0b2;
            border-radius: 8px;
            background: #fffbf0;
        }

        #sessionFormSection input,
        #sessionFormSection select,
        #sessionFormSection textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: clamp(0.9rem, 2vw, 1rem);
            width: 100%;
            margin: 5px 0;
            font-family: inherit;
        }

        #sessionFormSection input:focus,
        #sessionFormSection select:focus,
        #sessionFormSection textarea:focus {
            outline: none;
            border-color: #ffc107;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.2);
        }

        #sessionFormSection label {
            display: block;
            margin-top: 10px;
            font-weight: 600;
            color: #234;
            font-size: clamp(0.9rem, 2vw, 1rem);
        }

        #sessionFormSection hr {
            margin: 16px 0;
            border: none;
            border-top: 2px solid #ffe0b2;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row input,
        .form-row select,
        .form-row textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-row input:focus,
        .form-row select:focus,
        .form-row textarea:focus {
            outline: none;
            border-color: #ffc107;
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.2);
        }

        #sessionFormInvite,
        #sessionFormSeats,
        #sessionFormCandidates {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }

        /* Responsive breakpoints */
        @media (max-width: 1024px) {
            body {
                padding: 16px;
            }

            .dashboard-container {
                max-width: 100%;
            }

            .section {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 12px;
            }

            .stats {
                grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            }

            .users-list th,
            .users-list td {
                padding: 10px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .header h1 {
                width: 100%;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }

            .section {
                padding: 16px;
            }

            .filter-search {
                flex-direction: column;
            }

            .filter-search input {
                width: 100%;
                min-width: 0;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stats {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-number {
                font-size: 1.8rem;
            }

            .users-list {
                font-size: 0.85rem;
            }

            .users-list th,
            .users-list td {
                padding: 8px;
            }

            .status-badge {
                padding: 4px 8px;
                font-size: 10px;
            }

            .btn {
                padding: 10px 12px;
            }

            #sessionFormSection {
                padding: 12px;
            }

            #sessionFormSection input,
            #sessionFormSection select,
            #sessionFormSection textarea {
                width: 100%;
            }

            .form-row input,
            .form-row select,
            .form-row textarea {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .dashboard-container {
                margin: 0;
            }

            .header {
                margin-bottom: 20px;
                padding: 16px;
            }

            .header h1 {
                font-size: 1.3rem;
            }

            .header p {
                font-size: 0.85rem;
            }

            .header-actions {
                width: 100%;
                gap: 8px;
            }

            .btn {
                padding: 10px 12px;
                font-size: 0.85rem;
                width: 100%;
            }

            .section {
                padding: 12px;
                margin-bottom: 20px;
            }

            .section h2 {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }

            .section h3 {
                font-size: 1.1rem;
            }

            .section h4 {
                font-size: 1rem;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .stat-label {
                font-size: 0.8rem;
            }

            .users-list {
                font-size: 0.8rem;
            }

            .users-list th,
            .users-list td {
                padding: 6px;
            }

            .btn-approve,
            .btn-reject {
                width: 100%;
                margin: 4px 0;
            }

            #sessionFormSection {
                padding: 12px;
            }

            #sessionFormSection input,
            #sessionFormSection select,
            #sessionFormSection textarea {
                width: 100%;
                padding: 8px;
            }

            .filter-search input {
                width: 100%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .form-row input,
            .form-row select,
            .form-row textarea {
                width: 100%;
                padding: 8px;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .header-actions {
                display: none;
            }

            .section {
                box-shadow: none;
                page-break-inside: avoid;

                    #profileModal {
                        display: none;
                        position: fixed;
                        left: 0;
                        top: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.6);
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                        padding: 20px;
                    }

                    #profileModal > div {
                        background: var(--bg-primary);
                        width: 100%;
                        max-width: 500px;
                        padding: clamp(20px, 5vw, 30px);
                        border-radius: 12px;
                        box-shadow: var(--shadow-lg);
                        border: 1px solid var(--border-color);
                        color: var(--text-primary);
                        transition: all 0.3s ease;
                    }

                    #profileModal h3 {
                        margin-bottom: 20px;
                        color: var(--accent-primary);
                        font-size: clamp(1.3rem, 3vw, 1.6rem);
                    }

                    #profileModal label {
                        color: var(--text-primary);
                        font-weight: 500;
                        display: block;
                        margin-bottom: 6px;
                    }

                    #profileModal input {
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        border: 1px solid var(--border-color);
                        padding: 10px;
                        border-radius: 6px;
                        width: 100%;
                        transition: all 0.3s ease;
                        margin-bottom: 4px;
                    }

                    #profileModal input:focus {
                        outline: none;
                        border-color: var(--accent-primary);
                        box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
                    }

                    #profileModal input:disabled {
                        opacity: 0.6;
                        cursor: not-allowed;
                    }
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div>
                <h1>ðŸ“‹ Session Manager Dashboard</h1>
                <p id="managerEmail">Session Manager</p>
            </div>
            <div class="header-actions">
                <button class="btn" onclick="openProfileModal()">ðŸ‘¤ Profile</button>
                <button class="btn" onclick="openManagerChat()">ðŸ’¬ Chat</button>
                <button class="btn" onclick="logout()">ðŸšª Logout</button>
            </div>
        </div>

        <!-- My Assigned Sessions -->
        <div class="section">
            <h2>My Assigned Sessions</h2>
            <!-- Session edit form (hidden by default) -->
            <div id="sessionFormSection" style="display:none; margin-bottom:16px; padding:12px; border:1px solid #eee; border-radius:6px;">
                <h3 id="sessionFormTitle">Edit Session</h3>
                <form id="sessionForm">
                    <input type="hidden" id="sessionFormId" />
                    <div style="margin:6px 0;"><label>Session</label><br/><div id="sessionFormTitleDisplay" style="font-weight:bold; padding:6px 0;">(select a session to edit)</div></div>
                    <div style="margin:6px 0;"><label>Dates</label><br/><div id="sessionFormDatesDisplay" style="color:#666; padding:6px 0;"></div></div>
                    <div style="margin:6px 0;"><label>Description</label><br/><div id="sessionFormDescDisplay" style="color:#444; padding:6px 0;"></div></div>
                    <div style="margin:6px 0;"><label><input type="checkbox" id="sessionFormClosed" /> Closed</label></div>
                    <div style="margin-top:8px;">
                        <button class="btn" type="button" onclick="saveSessionForm()">Save</button>
                        <button class="btn" type="button" onclick="closeSessionForm()">Cancel</button>
                    </div>

                    <hr/>
                    <div id="sessionFormInvite" style="margin-top:8px;">
                        <h4>Invite Voter to this Session</h4>
                        <div style="display:flex; gap:8px; align-items:center; margin:6px 0;">
                            <input id="sessionFormInviteInput" placeholder="voter@example.com" style="padding:8px; width:40%;" />
                            <button class="btn" type="button" onclick="inviteVoterToSessionFromForm()">Invite</button>
                        </div>
                    </div>
                    <hr/>
                    <div id="sessionFormSeats" style="margin-top:8px;">
                        <h4>Seats (Positions) for this Session</h4>
                        <div style="display:flex; gap:8px; align-items:center; margin:6px 0;">
                            <input id="sessionFormSeatName" placeholder="Seat name (e.g. President)" style="padding:8px; width:40%;" />
                            <button class="btn" type="button" onclick="addSeatFromForm()">Add Seat</button>
                        </div>
                        <ul id="sessionFormSeatsList" style="padding-left:16px;"></ul>
                    </div>
                    <div id="sessionFormCandidates" style="margin-top:8px;">
                        <h4>Candidates for this Session</h4>
                        <div style="margin:6px 0;">
                            <label>Invited Voter</label><br/>
                            <select id="sessionFormVoterSelect" style="width:60%; padding:8px; margin:6px 0;"></select>
                            <div style="margin:6px 0; display:flex; gap:8px; align-items:center;">
                                <input id="sessionFormCandidateName" placeholder="Display name (optional)" style="flex:1; padding:8px;" />
                                <select id="sessionFormSeatSelect" style="width:200px; padding:8px;"></select>
                            </div>
                            <textarea id="sessionFormCandidateBio" placeholder="Bio (optional)" style="width:60%; padding:8px; margin:6px 0;" rows="2"></textarea>
                            <div style="margin:6px 0; display:flex; gap:8px; align-items:center;">
                                <input id="sessionFormCandidatePhoto" type="file" accept="image/*" />
                                <button class="btn" type="button" onclick="addCandidateFromForm()">Add Candidate</button>
                            </div>
                        </div>
                        <ul id="sessionFormCandidatesList" style="padding-left:16px;"></ul>
                    </div>
                </form>
            </div>
            <table class="users-list">
                <thead>
                    <tr>
                        <th>Session Title</th>
                        <th>Seats</th>
                        <th>Dates & Times</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sessionsList">
                    <!-- Sessions populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Manage Candidates by Session (cards) -->
        <div class="section">
            <h2>Manage Candidates (per Session)</h2>
            <div id="sessionCardsForCandidates">
                <!-- Session cards rendered here by JavaScript -->
            </div>
            <div style="margin-top:20px;">
                <h3>All Candidates Across My Sessions</h3>
                <table class="users-list">
                    <thead>
                        <tr>
                            <th>Session</th>
                            <th>Candidate Name</th>
                            <th>From Voter</th>
                            <th>Bio</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="candidatesBySessionList">
                        <!-- Candidates populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Participation Requests removed per project preference -->

        <!-- Session Reports -->
        <div class="section">
            <h2>Session Reports</h2>
            <div>
                <label>Select Session:</label>
                <select id="reportSession" style="width:60%; padding:10px; margin: 10px 0;">
                    <option value="">-- Choose a session --</option>
                </select>
            </div>
            <div style="margin-top:15px;">
                <button class="btn" onclick="generateVotersListReport()">Download Voters List</button>
                <button class="btn" onclick="generateCandidatesListReport()">Download Candidates List</button>
                <button class="btn" onclick="generateVotesSummaryReport()">Download Votes Summary (CSV)</button>
            </div>
            <table class="users-list" style="margin-top:20px;">
                <thead>
                    <tr>
                        <th>Session</th>
                        <th>Voters</th>
                        <th>Candidates</th>
                        <th>Total Votes Cast</th>
                    </tr>
                </thead>
                <tbody id="reportsTable">
                    <!-- Reports populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Session Statistics -->
        <div class="section">
            <h2>Session Statistics</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="statsAssignedSessions">0</div>
                    <div class="stat-label">Assigned Sessions</div>
                </div>
                <div class="stat-card">
                       <div class="stat-number" id="statsVoters">0</div>
                       <div class="stat-label">Voters</div>
                </div>
                <div class="stat-card">
                       <div class="stat-number" id="statsCandidates">0</div>
                       <div class="stat-label">Candidates</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statsTotalVotes">0</div>
                    <div class="stat-label">Total Votes Cast</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;">
        <div style="margin:auto; width:420px; text-align:left; background:var(--bg-primary); padding:20px; border-radius:10px; box-shadow:var(--shadow-lg); border:1px solid var(--border-color); color:var(--text-primary);">
            <h3>Profile Settings</h3>
            <div style="margin:12px 0;">
                <label for="profileName">Name</label>
                <input id="profileName" />
            </div>
            <div style="margin:12px 0;">
                <label for="profileEmail">Email</label>
                <input id="profileEmail" disabled />
            </div>
            <div style="margin:12px 0;">
                <label for="profileCurrentPassword">Current Password (required to change password)</label>
                <input id="profileCurrentPassword" type="password" />
            </div>
            <div style="margin:12px 0;">
                <label for="profileNewPassword">New Password</label>
                <input id="profileNewPassword" type="password" />
            </div>
            <div style="margin:12px 0;">
                <label for="profileConfirmPassword">Confirm New Password</label>
                <input id="profileConfirmPassword" type="password" />
            </div>
            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
                <button class="btn" type="button" onclick="closeProfileModal()">Cancel</button>
                <button class="btn" type="button" onclick="saveProfile()">Save</button>
            </div>
        </div>
    </div>

    <!-- Manager <> Super Admin Chat Modal -->
    <div id="managerChatModal" style="display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:1100;">
        <div style="margin:auto; width:720px; max-width:95%; text-align:left; background:var(--bg-primary); padding:18px; border-radius:10px; box-shadow:var(--shadow-lg); border:1px solid var(--border-color); color:var(--text-primary);">
            <h3>Manager â€” Admin Chat</h3>
            <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
                <label style="min-width:90px;">Session</label>
                <select id="managerChatSessionSelect" style="flex:1; padding:8px; border-radius:6px; border:1px solid var(--border-color); background:var(--bg-secondary); color:var(--text-primary);"></select>
                <button class="btn" onclick="closeManagerChat()">Close</button>
            </div>
            <div id="managerChatMessages" style="max-height:360px; overflow:auto; padding:8px; border:1px solid var(--border-color); background:var(--bg-secondary); border-radius:8px;"></div>
            <div style="display:flex; gap:8px; margin-top:10px;">
                <input id="managerChatInput" placeholder="Write a public message for this session..." style="flex:1; padding:10px; border-radius:6px; border:1px solid var(--border-color); background:var(--bg-primary); color:var(--text-primary);" />
                <button class="btn" onclick="sendManagerMessage()">Send</button>
            </div>
        </div>
    </div>

    <script src="db.js"></script>
    <script>
        function openProfileModal() {
            const raw = localStorage.getItem('currentUser');
            if (!raw) return alert('No user logged in');
            const user = JSON.parse(raw);
            document.getElementById('profileName').value = user.name || '';
            document.getElementById('profileEmail').value = user.email || '';
            document.getElementById('profileCurrentPassword').value = '';
            document.getElementById('profileNewPassword').value = '';
            document.getElementById('profileConfirmPassword').value = '';
            document.getElementById('profileModal').style.display = 'flex';
        }
        function closeProfileModal() { document.getElementById('profileModal').style.display = 'none'; }
        function saveProfile() {
            const raw = localStorage.getItem('currentUser');
            if (!raw) return alert('No user logged in');
            const user = JSON.parse(raw);
            const name = document.getElementById('profileName').value.trim();
            const current = document.getElementById('profileCurrentPassword').value;
            const np = document.getElementById('profileNewPassword').value;
            const cp = document.getElementById('profileConfirmPassword').value;

            const patch = {};
            if (name) patch.name = name;

            if (np || cp) {
                if (np !== cp) return alert('New password and confirmation do not match');
                if (!current) return alert('Enter current password to change password');
                if (current !== user.password) return alert('Current password is incorrect');
                patch.password = np;
            }

            const updated = DB.updateUser(user.email, patch);
            if (updated) {
                localStorage.setItem('currentUser', JSON.stringify(Object.assign({}, user, patch)));
                alert('Profile updated');
                closeProfileModal();
            } else {
                alert('Failed to update profile');
            }
        }
    </script>
    <script src="logout.js"></script>
    <script>
        // Get current manager email from localStorage
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const managerEmail = currentUser?.email || '';
        document.getElementById('managerEmail').textContent = managerEmail;

        // Load manager's assigned sessions
        function loadSessions() {
            DB.autoCloseExpiredSessions();
            const sessions = DB.getSessions();
            const tbody = document.getElementById('sessionsList');
            tbody.innerHTML = '';

            // Filter sessions assigned to this manager
            const assignedSessions = sessions.filter(s => s.manager === managerEmail);

            const reportSelect = document.getElementById('reportSession');
            reportSelect.innerHTML = '<option value="">-- Choose a session --</option>';

            const formatDateTime = (dt) => {
                if (!dt) return '';
                const d = new Date(dt);
                return d.toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            };

            assignedSessions.forEach(s => {
                const row = document.createElement('tr');
                const active = DB.isSessionActive(s);
                const statusHtml = active ? '<span class="status-badge status-approved">Active</span>' : (s.closed ? '<span class="status-badge status-rejected">Closed</span>' : '<span class="status-badge">Inactive</span>');
                row.innerHTML = `
                    <td>${s.title}</td>
                    <td>${s.seats || 1} Seats</td>
                    <td>
                        ${formatDateTime(s.startDate)} - ${formatDateTime(s.endDate)}
                        <div id="countdown_${s.id}" class="session-countdown" style="font-size:12px;color:#666; margin-top:6px;"></div>
                    </td>
                    <td id="status_${s.id}">${statusHtml}</td>
                    <td>
                        <button class="btn" onclick="toggleSessionStatus('${s.id}')">${s.closed ? 'Reopen' : 'Close'}</button>
                        <button class="btn" onclick="toggleSessionEditForm('${s.id}')">Edit</button>
                    </td>
                `;
                tbody.appendChild(row);

                // Add to report selector
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.title;
                reportSelect.appendChild(opt);


            });

            // Render session tiles/cards for per-session management
            renderSessionCardsForCandidates(assignedSessions);

            if (assignedSessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No sessions assigned to you yet.</td></tr>';
            }

            loadCandidatesForManagerSessions();
            updateStats();
        }

        function formatRemaining(ms) {
            if (ms <= 0) return '0s';
            const sec = Math.floor(ms / 1000) % 60;
            const min = Math.floor(ms / (1000 * 60)) % 60;
            const hrs = Math.floor(ms / (1000 * 60 * 60)) % 24;
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            const parts = [];
            if (days) parts.push(days + 'd');
            if (hrs) parts.push(String(hrs).padStart(2,'0') + 'h');
            parts.push(String(min).padStart(2,'0') + 'm');
            parts.push(String(sec).padStart(2,'0') + 's');
            return parts.join(' ');
        }

        function updateCountdownsManager() {
            DB.autoCloseExpiredSessions();
            const sessions = DB.getSessions().filter(s => s.manager === managerEmail);
            const now = Date.now();
            for (const s of sessions) {
                const statusEl = document.getElementById(`status_${s.id}`);
                const start = s.startDate ? new Date(s.startDate).getTime() : -Infinity;
                const end = s.endDate ? new Date(s.endDate).getTime() : Infinity;
                const active = DB.isSessionActive(s);
                const activeLabelNew = active ? '<span class="status-badge status-approved">Active</span>' : (s.closed ? '<span class="status-badge status-rejected">Closed</span>' : '<span class="status-badge">Inactive</span>');
                if (statusEl && statusEl.innerHTML !== activeLabelNew) { loadSessions(); return; }
                const cdEl = document.getElementById(`countdown_${s.id}`);
                if (!cdEl) continue;
                if (now < start) {
                    cdEl.textContent = 'Starts in ' + formatRemaining(start - now);
                } else if (now <= end && isFinite(end)) {
                    cdEl.textContent = 'Ends in ' + formatRemaining(end - now);
                } else {
                    cdEl.textContent = '';
                }
            }
        }

        setInterval(updateCountdownsManager, 1000);

        

        function toggleSessionStatus(sessionId) {
            const sessions = DB.getSessions();
            const s = sessions.find(x => x.id === sessionId);
            if (!s) return alert('Session not found');
            s.closed = !s.closed;
            DB.saveSessions(sessions);
            loadSessions();
            alert(s.closed ? 'Session closed.' : 'Session reopened.');
        }

        // Session form helpers
        function toggleSessionEditForm(sessionId) {
            const formSection = document.getElementById('sessionFormSection');
            const currentId = document.getElementById('sessionFormId').value;
            
            // If form is open and same session, close it
            if (formSection.style.display !== 'none' && currentId === sessionId) {
                closeSessionForm();
                return;
            }
            
            // Otherwise open the form for this session
            openSessionForm(sessionId);
        }
        
        function openSessionForm(sessionId) {
            if (!sessionId) return alert('Managers can only edit existing sessions. Session creation is restricted to Super Admin.');
            document.getElementById('sessionFormSection').style.display = 'block';
            document.getElementById('sessionFormTitle').textContent = 'Edit Session';
            const idEl = document.getElementById('sessionFormId');
            const closedEl = document.getElementById('sessionFormClosed');
            idEl.value = '';
            closedEl.checked = false;
            document.getElementById('sessionFormCandidatesList').innerHTML = '';

            const s = DB.getSessions().find(x => x.id === sessionId);
            if (s) {
                idEl.value = s.id;
                closedEl.checked = !!s.closed;
                document.getElementById('sessionFormTitleDisplay').textContent = s.title || '';
                document.getElementById('sessionFormDatesDisplay').textContent = `${s.startDate || ''} ${s.startDate && s.endDate ? ' - ' : ''} ${s.endDate || ''}`;
                document.getElementById('sessionFormDescDisplay').textContent = s.description || '';
            }
            // populate invited voters and candidates for this session in the form
            populateSessionFormCandidates(sessionId);
        }

        function closeSessionForm() {
            document.getElementById('sessionFormSection').style.display = 'none';
        }

        function saveSessionForm() {
            const id = document.getElementById('sessionFormId').value;
                const closed = document.getElementById('sessionFormClosed').checked;
            if (!id) return alert('Only Super Admin can create sessions; managers may only edit assigned sessions.');
                DB.updateSession(id, { closed });
            alert('Session updated');
            closeSessionForm();
            loadSessions();
        }

        // Candidate helpers for session form
        function populateSessionFormCandidates(sessionId) {
            const voterSelect = document.getElementById('sessionFormVoterSelect');
            const candList = document.getElementById('sessionFormCandidatesList');
            voterSelect.innerHTML = '';
            candList.innerHTML = '';
            if (!sessionId) return;
            const invites = JSON.parse(localStorage.getItem('voterInvites') || '{}');
            const voters = invites[sessionId] || [];
            const placeholder = document.createElement('option'); placeholder.value = ''; placeholder.textContent = '-- choose invited voter --';
            voterSelect.appendChild(placeholder);
            voters.forEach(v => {
                const opt = document.createElement('option'); opt.value = v; opt.textContent = v; voterSelect.appendChild(opt);
            });

            // populate seat select for assigning candidates
            populateSessionFormSeats(sessionId);

            const candidates = DB.getCandidates().filter(c => c.sessionId === sessionId);
            candidates.forEach(c => {
                const pos = c.positionId ? DB.getPositions().find(p => p.id === c.positionId) : null;
                const li = document.createElement('li');
                const img = c.photo ? `<img src="${c.photo}" class="candidate-photo" />` : '';
                li.innerHTML = `${img} ${c.name || ''} ${pos ? '('+pos.name+')' : ''} (${c.fromVoter || ''}) <button class="btn delete-btn" style="background:#dc3545; margin-left:8px;" onclick="removeCandidateFromForm('${c.id}','${sessionId}')">Remove</button>`;
                candList.appendChild(li);
            });
        }

        // Seats (positions) helpers
        function populateSessionFormSeats(sessionId) {
            const seatsUl = document.getElementById('sessionFormSeatsList');
            const seatSelect = document.getElementById('sessionFormSeatSelect');
            seatsUl.innerHTML = '';
            seatSelect.innerHTML = '<option value="">-- Select seat (optional) --</option>';
            if (!sessionId) return;
            const s = DB.getSessions().find(x => x.id === sessionId);
            const posIds = s?.positions || [];
            const positions = DB.getPositions().filter(p => posIds.includes(p.id));
            positions.forEach(p => {
                const li = document.createElement('li');
                li.innerHTML = `<input value="${p.name}" onchange="updateSeatName('${p.id}', this.value)" style="padding:6px; width:60%;" /> <button class="btn" style="background:#dc3545; margin-left:8px;" onclick="removeSeatFromForm('${p.id}','${sessionId}')">Remove</button>`;
                seatsUl.appendChild(li);

                const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.name; seatSelect.appendChild(opt);
            });
        }

        function addSeatFromForm() {
            const sessionId = document.getElementById('sessionFormId').value;
            const name = document.getElementById('sessionFormSeatName').value.trim();
            if (!sessionId) return alert('Save the session first before adding seats');
            if (!name) return alert('Enter a seat name');
            const pos = DB.addPosition({ name: name, sessionId });
            // attach to session
            const s = DB.getSessions().find(x => x.id === sessionId);
            s.positions = s.positions || [];
            s.positions.push(pos.id);
            DB.updateSession(sessionId, { positions: s.positions });
            document.getElementById('sessionFormSeatName').value = '';
            populateSessionFormSeats(sessionId);
            populateSessionFormCandidates(sessionId);
            loadCandidatesForManagerSessions();
        }

        function removeSeatFromForm(positionId, sessionId) {
            if (!confirm('Remove this seat (position)? Candidates assigned to it will remain unassigned.')) return;
            DB.deletePosition(positionId);
            const s = DB.getSessions().find(x => x.id === sessionId);
            s.positions = (s.positions || []).filter(pid => pid !== positionId);
            DB.updateSession(sessionId, { positions: s.positions });
            populateSessionFormSeats(sessionId);
            populateSessionFormCandidates(sessionId);
            loadCandidatesForManagerSessions();
        }

        function updateSeatName(positionId, newName) {
            DB.updatePosition(positionId, { name: newName });
            populateSessionFormSeats(document.getElementById('sessionFormId').value);
            populateVotersAndCandidatesForCard(document.getElementById('sessionFormId').value);
            loadCandidatesForManagerSessions();
        }

        function addCandidateFromForm() {
            const sessionId = document.getElementById('sessionFormId').value;
            if (!sessionId) return alert('Save the session first before adding candidates');
            const voter = document.getElementById('sessionFormVoterSelect').value;
            if (!voter) return alert('Select an invited voter');
            const name = document.getElementById('sessionFormCandidateName').value.trim() || voter.split('@')[0];
            const positionId = document.getElementById('sessionFormSeatSelect').value || null;
            const bio = document.getElementById('sessionFormCandidateBio').value.trim();
            const photoInput = document.getElementById('sessionFormCandidatePhoto');
            const file = photoInput?.files?.[0];
            const finalize = (photoData) => {
                DB.addCandidate({ name, bio, positionId: positionId, sessionId, fromVoter: voter, photo: photoData });
                populateSessionFormCandidates(sessionId);
                loadCandidatesForManagerSessions();
                if (photoInput) photoInput.value = '';
                alert(`${name} added as candidate`);
            };
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) { finalize(e.target.result); };
                reader.readAsDataURL(file);
            } else {
                finalize(null);
            }
        }

        function removeCandidateFromForm(candidateId, sessionId) {
            if (!confirm('Remove this candidate?')) return;
            DB.deleteCandidate(candidateId);
            populateSessionFormCandidates(sessionId);
            loadCandidatesForManagerSessions();
        }

        // --- Candidate management (per-session cards) ---
        function renderSessionCardsForCandidates(sessions) {
            const container = document.getElementById('sessionCardsForCandidates');
            container.innerHTML = '';
            sessions.forEach(s => {
                const card = document.createElement('div');
                card.style.border = '1px solid #ddd';
                card.style.padding = '12px';
                card.style.marginBottom = '12px';
                card.style.borderRadius = '6px';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:bold;">${s.title}</div>
                            <div style="font-size:12px; color:#666;">${s.startDate || ''} - ${s.endDate || ''}</div>
                        </div>
                        <div>
                            <button class="btn" onclick="toggleCandidatePanel('${s.id}')">Add Candidate</button>
                            <button class="btn" onclick="toggleListView('${s.id}','voters')">Toggle Voters</button>
                            <button class="btn" onclick="toggleListView('${s.id}','candidates')">Toggle Candidates</button>
                        </div>
                    </div>
                    <div id="candidatePanel_${s.id}" style="display:none; margin-top:10px;">
                    <label>Invite Voter to this Session</label>
                    <div style="display:flex; gap:8px; align-items:center; margin:6px 0;">
                        <input id="inviteInput_${s.id}" placeholder="voter@example.com" style="padding:8px; width:40%;" />
                        <button class="btn" onclick="inviteVoterToSessionFromCard('${s.id}')">Invite</button>
                    </div>
                    <label>Invited Voters</label>
                    <select id="candidateVoterSelect_${s.id}" style="width:60%; padding:8px; margin:6px 0;">
                        <option value="">-- Choose invited voter --</option>
                    </select>
                    <div style="display:flex; gap:8px; align-items:center; margin:6px 0;">
                        <input id="candidateNameInput_${s.id}" placeholder="Candidate display name (optional)" style="flex:1; padding:8px;" />
                        <select id="candidateSeatSelect_${s.id}" style="width:200px; padding:8px;"></select>
                    </div>
                    <textarea id="candidateBioInput_${s.id}" placeholder="Short bio (optional)" style="width:60%; padding:8px; margin:6px 0;" rows="2"></textarea>
                    <div style="display:flex; gap:8px; align-items:center; margin:6px 0;">
                        <input id="candidatePhotoInput_${s.id}" type="file" accept="image/*" />
                        <button class="btn" onclick="addCandidateFromCard('${s.id}')">Add Candidate</button>
                    </div>
                    </div>
                    <div id="votersList_${s.id}" style="display:none; margin-top:10px;">
                        <h4>Invited Voters</h4>
                        <ul id="votersList_ul_${s.id}" style="padding-left:16px;"></ul>
                    </div>
                    <div id="candidatesList_${s.id}" style="display:none; margin-top:10px;">
                        <h4>Candidates</h4>
                        <ul id="candidatesList_ul_${s.id}" style="padding-left:16px;"></ul>
                    </div>
                `;
                container.appendChild(card);
                populateVotersAndCandidatesForCard(s.id);
            });
        }

        function populateVotersAndCandidatesForCard(sessionId) {
            // populate voters
            const votersUl = document.getElementById(`votersList_ul_${sessionId}`);
            const select = document.getElementById(`candidateVoterSelect_${sessionId}`);
            if (!votersUl || !select) return;
            votersUl.innerHTML = '';
            select.innerHTML = '<option value="">-- Choose invited voter --</option>';
            const data = JSON.parse(localStorage.getItem('voterInvites') || '{}');
            const voters = data[sessionId] || [];
            voters.forEach(email => {
                const li = document.createElement('li');
                li.innerHTML = `${email} <button class="btn delete-btn" style="background:#dc3545; margin-left:8px;" onclick="removeVoterFromCard('${sessionId}','${email}')">Remove</button>`;
                votersUl.appendChild(li);
                const opt = document.createElement('option'); opt.value = email; opt.textContent = email; select.appendChild(opt);
            });

            // populate candidates
            const candUl = document.getElementById(`candidatesList_ul_${sessionId}`);
            candUl.innerHTML = '';
            const candidates = DB.getCandidates().filter(c => c.sessionId === sessionId);
            const positions = DB.getPositions().filter(p => (DB.getSessions().find(s => s.id === sessionId)?.positions || []).includes(p.id));
            // show candidates grouped by position
            const unassigned = candidates.filter(c => !c.positionId);
            positions.forEach(p => {
                const header = document.createElement('li');
                header.innerHTML = `<strong>${p.name}</strong>`;
                candUl.appendChild(header);
                candidates.filter(c => c.positionId === p.id).forEach(c => {
                    const li = document.createElement('li');
                    const img = c.photo ? `<img src="${c.photo}" class="candidate-photo" />` : '';
                    li.innerHTML = `${img} ${c.name || ''} (${c.fromVoter || ''}) <button class="btn delete-btn" style="background:#dc3545; margin-left:8px;" onclick="removeCandidate('${c.id}'); populateVotersAndCandidatesForCard('${sessionId}'); loadCandidatesForManagerSessions();">Remove</button>`;
                    candUl.appendChild(li);
                });
            });
            if (unassigned.length) {
                const header = document.createElement('li'); header.innerHTML = `<strong>Unassigned</strong>`; candUl.appendChild(header);
                unassigned.forEach(c => {
                    const li = document.createElement('li');
                    const img = c.photo ? `<img src="${c.photo}" class="candidate-photo" />` : '';
                    li.innerHTML = `${img} ${c.name || ''} (${c.fromVoter || ''}) <button class="btn delete-btn" style="background:#dc3545; margin-left:8px;" onclick="removeCandidate('${c.id}'); populateVotersAndCandidatesForCard('${sessionId}'); loadCandidatesForManagerSessions();">Remove</button>`;
                    candUl.appendChild(li);
                });
            }
            // populate seat select for card
            const seatSelect = document.getElementById(`candidateSeatSelect_${sessionId}`);
            if (seatSelect) {
                seatSelect.innerHTML = '<option value="">-- Select seat (optional) --</option>';
                positions.forEach(p => { const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.name; seatSelect.appendChild(opt); });
            }
        }

        function toggleCandidatePanel(sessionId) {
            const el = document.getElementById(`candidatePanel_${sessionId}`);
            if (!el) return;
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function toggleListView(sessionId, type) {
            const votersEl = document.getElementById(`votersList_${sessionId}`);
            const candidatesEl = document.getElementById(`candidatesList_${sessionId}`);
            if (type === 'voters') {
                votersEl.style.display = votersEl.style.display === 'none' ? 'block' : 'none';
            } else {
                candidatesEl.style.display = candidatesEl.style.display === 'none' ? 'block' : 'none';
            }
        }

        function addCandidateFromCard(sessionId) {
            const voterSelect = document.getElementById(`candidateVoterSelect_${sessionId}`);
            const nameInput = document.getElementById(`candidateNameInput_${sessionId}`);
            const bioInput = document.getElementById(`candidateBioInput_${sessionId}`);
            const seatSelect = document.getElementById(`candidateSeatSelect_${sessionId}`);
            const photoInput = document.getElementById(`candidatePhotoInput_${sessionId}`);
            const voterEmail = voterSelect.value;
            if (!voterEmail) return alert('Please select an invited voter to promote');
            const displayName = nameInput.value.trim() || voterEmail.split('@')[0];
            const bio = bioInput.value.trim();
            const positionId = seatSelect ? (seatSelect.value || null) : null;
            const file = photoInput?.files?.[0];
            const finalize = (photoData) => {
                DB.addCandidate({ name: displayName, bio: bio, positionId: positionId, sessionId: sessionId, fromVoter: voterEmail, photo: photoData });
                if (photoInput) photoInput.value = '';
                populateVotersAndCandidatesForCard(sessionId);
                loadCandidatesForManagerSessions();
                alert(`${displayName} added as candidate for the session.`);
            };
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) { finalize(e.target.result); };
                reader.readAsDataURL(file);
            } else {
                finalize(null);
            }
        }

        function removeCandidate(id) {
            if (!confirm('Remove this candidate?')) return;
            DB.deleteCandidate(id);
            loadCandidatesForManagerSessions();
        }

        // Invite a voter directly from a session card
        function inviteVoterToSessionFromCard(sessionId) {
            const input = document.getElementById(`inviteInput_${sessionId}`);
            if (!input) return;
            const email = input.value.trim().toLowerCase();
            if (!email) return alert('Enter an email');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) return alert('Enter a valid email');
            const data = JSON.parse(localStorage.getItem('voterInvites') || '{}');
            data[sessionId] = data[sessionId] || [];
            if (data[sessionId].includes(email)) return alert('This voter is already invited to this session');
            data[sessionId].push(email);
            localStorage.setItem('voterInvites', JSON.stringify(data));
            input.value = '';
            populateVotersAndCandidatesForCard(sessionId);
            alert(`${email} invited to session.`);
        }

        function removeVoterFromCard(sessionId, email) {
            if (!confirm(`Remove ${email} from this session?`)) return;
            const data = JSON.parse(localStorage.getItem('voterInvites') || '{}');
            if (data[sessionId]) {
                data[sessionId] = data[sessionId].filter(v => v !== email);
                if (data[sessionId].length === 0) delete data[sessionId];
            }
            localStorage.setItem('voterInvites', JSON.stringify(data));
            populateVotersAndCandidatesForCard(sessionId);
            alert('Voter removed');
        }

        // Invite from session form
        function inviteVoterToSessionFromForm() {
            const sessionId = document.getElementById('sessionFormId').value;
            if (!sessionId) return alert('Cannot invite: session not selected');
            const input = document.getElementById('sessionFormInviteInput');
            if (!input) return;
            const email = input.value.trim().toLowerCase();
            if (!email) return alert('Enter an email');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) return alert('Enter a valid email');
            const data = JSON.parse(localStorage.getItem('voterInvites') || '{}');
            data[sessionId] = data[sessionId] || [];
            if (data[sessionId].includes(email)) return alert('This voter is already invited to this session');
            data[sessionId].push(email);
            localStorage.setItem('voterInvites', JSON.stringify(data));
            input.value = '';
            populateSessionFormCandidates(sessionId);
            populateVotersAndCandidatesForCard(sessionId);
            alert(`${email} invited to session.`);
        }
        // Load candidates for all sessions assigned to this manager
        function loadCandidatesForManagerSessions() {
            const sessions = DB.getSessions().filter(s => s.manager === managerEmail);
            const tbody = document.getElementById('candidatesBySessionList');
            tbody.innerHTML = '';
        }

        // Participation requests handling removed from manager dashboard



        // CSV Export functions
        function generateVotersListReport() {
            const sessionId = document.getElementById('reportSession').value;
            if (!sessionId) return alert('Please select a session');

            const invites = JSON.parse(localStorage.getItem('voterInvites') || '{}');
            const allVoters = invites[sessionId] || [];
            const session = DB.getSessions().find(s => s.id === sessionId);
            const settings = DB.getSettings();
            const systemName = settings.name || 'FABRIS Voting System';

            let csv = `System: ${systemName}\nSession: ${session.title}\n\n`;
            csv += 'Voter Email\n';
            csv += allVoters.map(v => v).join('\n');
            
            const filename = `Voters_${systemName.replace(/\s+/g, '_')}_${session.title.replace(/\s+/g, '_')}.csv`;
            downloadCSV(csv, filename);
        }

        function generateCandidatesListReport() {
            const sessionId = document.getElementById('reportSession').value;
            if (!sessionId) return alert('Please select a session');

            const session = DB.getSessions().find(s => s.id === sessionId);
            const settings = DB.getSettings();
            const systemName = settings.name || 'FABRIS Voting System';
            const candidates = DB.getCandidates().filter(c => c.sessionId === sessionId);
            const positions = DB.getPositions().filter(p => session.positions && session.positions.includes(p.id));

            let csv = `System: ${systemName}\nSession: ${session.title}\n\n`;
            
            if (positions.length === 0) {
                // Legacy single-choice session - no seats
                csv += 'Candidate Name,Candidate From\n';
                csv += candidates.map(c => `${c.name || ''},${c.voterEmail || ''}`).join('\n');
            } else {
                // Multi-seat session - include seat/position
                csv += 'Seat/Position,Candidate Name,Candidate From\n';
                positions.forEach(pos => {
                    const posCandidates = candidates.filter(c => c.positionId === pos.id);
                    posCandidates.forEach(c => {
                        csv += `${pos.name || ''},${c.name || ''},${c.voterEmail || ''}\n`;
                    });
                });
            }
            
            const filename = `Candidates_${systemName.replace(/\s+/g, '_')}_${session.title.replace(/\s+/g, '_')}.csv`;
            downloadCSV(csv, filename);
        }

        function generateVotesSummaryReport() {
            const sessionId = document.getElementById('reportSession').value;
            if (!sessionId) return alert('Please select a session');

            const votes = DB.getVotes().filter(v => v.sessionId === sessionId);
            const session = DB.getSessions().find(s => s.id === sessionId);
            const positions = DB.getPositions();
            const candidates = DB.getCandidates();

            let csv = 'Position,Candidate,Vote Count\n';
            const voteCount = {};

            votes.forEach(v => {
                const key = `${v.positionId}|${v.candidateId}`;
                voteCount[key] = (voteCount[key] || 0) + 1;
            });

            Object.entries(voteCount).forEach(([key, count]) => {
                const [posId, candId] = key.split('|');
                const pos = positions.find(p => p.id === posId);
                const cand = candidates.find(c => c.id === candId);
                csv += `${pos ? pos.name : ''},${cand ? cand.name : ''},${count}\n`;
            });

            downloadCSV(csv, `votes_summary_${session.title.replace(/\s+/g, '_')}.csv`);
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Generate reports summary table
        function generateReportsSummary() {
            const sessions = DB.getSessions().filter(s => s.manager === managerEmail);
            const tbody = document.getElementById('reportsTable');
            tbody.innerHTML = '';

            sessions.forEach(s => {
                const invites = JSON.parse(localStorage.getItem('voterInvites') || '{}');
                const votersCount = (invites[s.id] || []).length;
                const candidatesCount = DB.getCandidates().filter(c => c.sessionId === s.id).length;
                const votes = DB.getVotes().filter(v => v.sessionId === s.id).length;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${s.title}</td>
                    <td>${votersCount}</td>
                    <td>${candidatesCount}</td>
                    <td>${votes}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update statistics
        function updateStats() {
            const sessions = DB.getSessions().filter(s => s.manager === managerEmail);
               const votes = DB.getVotes().filter(v => sessions.map(s => s.id).includes(v.sessionId)).length;
               const votersCount = sessions.reduce((sum, s) => {
                   const invites = JSON.parse(localStorage.getItem('voterInvites') || '{}');
                   return sum + (invites[s.id] || []).length;
               }, 0);
               const candidatesCount = DB.getCandidates().filter(c => sessions.map(s => s.id).includes(c.sessionId)).length;

            document.getElementById('statsAssignedSessions').textContent = sessions.length;
               document.getElementById('statsVoters').textContent = votersCount;
               document.getElementById('statsCandidates').textContent = candidatesCount;
            document.getElementById('statsTotalVotes').textContent = votes;
        }

        // Manager <-> Super Admin chat utilities
        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, function (s) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[s]; });
        }
        function openManagerChat() {
            // populate sessions this manager manages
            const sessions = DB.getSessions().filter(s => s.manager === managerEmail);
            const sel = document.getElementById('managerChatSessionSelect');
            sel.innerHTML = '';
            sessions.forEach(s => { const o = document.createElement('option'); o.value = s.id; o.textContent = s.title; sel.appendChild(o); });
            if (sessions.length === 0) { sel.innerHTML = '<option value="">(no sessions assigned)</option>'; }
            document.getElementById('managerChatModal').style.display = 'flex';
            if (sessions.length) { renderManagerChat(sessions[0].id); sel.value = sessions[0].id; }
            sel.onchange = function(){ renderManagerChat(this.value); };
        }

        function closeManagerChat() { document.getElementById('managerChatModal').style.display = 'none'; }

        function renderManagerChat(sessionId) {
            const container = document.getElementById('managerChatMessages');
            container.innerHTML = '';
            if (!sessionId) return;
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const myEmail = currentUser.email || '';
            const chats = DB.getSessionChats().filter(c => c.sessionId === sessionId).sort((a,b)=>a.timestamp-b.timestamp);
            chats.forEach(m => {
                const isOwn = m.role === 'manager';
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.justifyContent = isOwn ? 'flex-end' : 'flex-start';
                div.style.marginBottom = '12px';
                div.style.paddingLeft = isOwn ? '40px' : '0';
                div.style.paddingRight = isOwn ? '0' : '40px';
                const bubble = document.createElement('div');
                bubble.style.maxWidth = '60%';
                bubble.style.padding = '12px 14px';
                bubble.style.borderRadius = isOwn ? '16px 4px 16px 16px' : '4px 16px 16px 16px';
                bubble.style.backgroundColor = isOwn ? 'var(--accent-primary)' : 'var(--bg-secondary)';
                bubble.style.color = isOwn ? 'white' : 'var(--text-primary)';
                bubble.style.boxShadow = '0 2px 8px rgba(0,0,0,0.12)';
                bubble.innerHTML = `
                    <div style="font-size:0.85rem;font-weight:600;margin-bottom:4px;opacity:0.9;">${m.from} <span style="font-weight:400;font-size:0.8rem;">(${m.role})</span></div>
                    <div style="margin-bottom:4px;">${escapeHtml(m.text)}</div>
                    <div style="font-size:0.75rem;opacity:0.7;text-align:right;">${new Date(m.timestamp).toLocaleTimeString()}</div>
                `;
                div.appendChild(bubble);
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        function sendManagerMessage() {
            const sel = document.getElementById('managerChatSessionSelect');
            const sessionId = sel.value;
            const input = document.getElementById('managerChatInput');
            const text = (input.value||'').trim();
            if (!sessionId) return alert('Select a session');
            if (!text) return;
            DB.addSessionChat({ sessionId, from: managerEmail || 'manager', role: 'manager', text, timestamp: Date.now() });
            input.value = '';
            renderManagerChat(sessionId);
        }

        // Initial load
        loadSessions();
        generateReportsSummary();
    </script>
    <script src="dark-mode.js"></script>
</body>
</html> 